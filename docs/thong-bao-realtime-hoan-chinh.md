# H·ªá Th·ªëng Th√¥ng B√°o Realtime - H∆∞·ªõng D·∫´n Ho√†n Ch·ªânh

## üìã T·ªïng Quan

H·ªá th·ªëng th√¥ng b√°o realtime s·ª≠ d·ª•ng Laravel Echo + Pusher ƒë·ªÉ g·ª≠i th√¥ng b√°o t·ª©c th·ªùi cho admin v√† kh√°ch h√†ng khi c√≥ s·ª± ki·ªán quan tr·ªçng x·∫£y ra.

## üèóÔ∏è Ki·∫øn Tr√∫c H·ªá Th·ªëng

### 1. Backend Components

#### Models
- **Notification Model**: `app/Models/Notification.php`
  - L∆∞u tr·ªØ th√¥ng b√°o trong database
  - Quan h·ªá v·ªõi User model

#### Events
- **OrderCreated**: `app/Events/OrderCreated.php`
  - K√≠ch ho·∫°t khi c√≥ ƒë∆°n h√†ng m·ªõi
  - Broadcast ƒë·∫øn channel `admin-orders`
  - L∆∞u th√¥ng b√°o cho t·∫•t c·∫£ admin

- **OrderStatusUpdated**: `app/Events/OrderStatusUpdated.php`
  - K√≠ch ho·∫°t khi tr·∫°ng th√°i ƒë∆°n h√†ng thay ƒë·ªïi
  - Broadcast ƒë·∫øn channel ri√™ng c·ªßa kh√°ch h√†ng

- **WalletDeposited**: `app/Events/WalletDeposited.php`
  - K√≠ch ho·∫°t khi kh√°ch h√†ng n·∫°p ti·ªÅn v√†o v√≠
  - Broadcast ƒë·∫øn channel ri√™ng c·ªßa kh√°ch h√†ng (`customer-{userId}`)
  - Broadcast ƒë·∫øn channel admin (`admin-wallets`)
  - L∆∞u th√¥ng b√°o cho kh√°ch h√†ng v√† t·∫•t c·∫£ admin

- **WalletWithdrawn**: `app/Events/WalletWithdrawn.php`
  - K√≠ch ho·∫°t khi kh√°ch h√†ng r√∫t ti·ªÅn t·ª´ v√≠
  - Broadcast ƒë·∫øn channel ri√™ng c·ªßa kh√°ch h√†ng (`customer-{userId}`)
  - Broadcast ƒë·∫øn channel admin (`admin-wallets`)
  - L∆∞u th√¥ng b√°o cho kh√°ch h√†ng v√† t·∫•t c·∫£ admin

#### Database
```sql
-- Migration: notifications table
CREATE TABLE notifications (
    id CHAR(36) PRIMARY KEY,
    user_id CHAR(36),
    title VARCHAR(255),
    message TEXT,
    type ENUM('info', 'success', 'warning', 'error'),
    data JSON,
    read_at TIMESTAMP NULL,
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);
```

### 2. Frontend Components

#### JavaScript Files
- **resources/js/echo.js**: C·∫•u h√¨nh Laravel Echo
- **public/js/notifications.js**: X·ª≠ l√Ω th√¥ng b√°o realtime
- **resources/js/app.js**: Import echo.js

#### Views
- **layouts/backend.blade.php**: Layout cho admin
- **layouts/app.blade.php**: Layout cho frontend
- **test-notification.blade.php**: Trang test h·ªá th·ªëng

## ‚öôÔ∏è C·∫•u H√¨nh

### 1. Environment Variables (.env)
```env
BROADCAST_CONNECTION=pusher
BROADCAST_DRIVER=pusher

PUSHER_APP_ID=2037895
PUSHER_APP_KEY=4829621e97569df33e7c
PUSHER_APP_SECRET=3110a2fc236e55c753d9
PUSHER_HOST=
PUSHER_PORT=443
PUSHER_SCHEME=https
PUSHER_APP_CLUSTER=ap2

VITE_PUSHER_APP_KEY="${PUSHER_APP_KEY}"
VITE_PUSHER_APP_CLUSTER="${PUSHER_APP_CLUSTER}"
VITE_PUSHER_HOST="${PUSHER_HOST}"
VITE_PUSHER_PORT="${PUSHER_PORT}"
VITE_PUSHER_SCHEME="${PUSHER_SCHEME}"

QUEUE_CONNECTION=sync
```

### 2. Vite Configuration (vite.config.js)
```javascript
import { defineConfig } from 'vite';
import laravel from 'laravel-vite-plugin';

export default defineConfig({
    plugins: [
        laravel({
            input: ['resources/css/app.css', 'resources/js/app.js'],
            refresh: true,
        }),
    ],
});
```

### 3. Broadcasting Configuration (config/broadcasting.php)
```php
'pusher' => [
    'driver' => 'pusher',
    'key' => env('PUSHER_APP_KEY'),
    'secret' => env('PUSHER_APP_SECRET'),
    'app_id' => env('PUSHER_APP_ID'),
    'options' => [
        'cluster' => env('PUSHER_APP_CLUSTER'),
        'encrypted' => true,
        'host' => env('PUSHER_HOST') ?: 'api-'.env('PUSHER_APP_CLUSTER', 'mt1').'.pusherapp.com',
        'port' => env('PUSHER_PORT', 443),
        'scheme' => env('PUSHER_SCHEME', 'https'),
    ],
],
```

## üöÄ C√°ch S·ª≠ D·ª•ng

### 1. K√≠ch Ho·∫°t Th√¥ng B√°o ƒê∆°n H√†ng M·ªõi

```php
// Trong Controller khi t·∫°o ƒë∆°n h√†ng
use App\Events\OrderCreated;

public function store(Request $request)
{
    // T·∫°o ƒë∆°n h√†ng
    $order = Order::create($request->validated());
    
    // K√≠ch ho·∫°t event
    event(new OrderCreated($order));
    
    return response()->json(['success' => true]);
}
```

### 2. K√≠ch Ho·∫°t Th√¥ng B√°o C·∫≠p Nh·∫≠t Tr·∫°ng Th√°i

```php
// Trong Controller khi c·∫≠p nh·∫≠t tr·∫°ng th√°i
use App\Events\OrderStatusUpdated;

public function updateStatus(Request $request, Order $order)
{
    $oldStatus = $order->status;
    $order->update(['status' => $request->status]);
    
    // K√≠ch ho·∫°t event
    event(new OrderStatusUpdated($order, $oldStatus, $request->status));
    
    return response()->json(['success' => true]);
}
```

### 3. K√≠ch Ho·∫°t Th√¥ng B√°o N·∫°p Ti·ªÅn V√≠

```php
// Trong Controller khi n·∫°p ti·ªÅn v√†o v√≠
use App\Events\WalletDeposited;

public function deposit(Request $request)
{
    $user = auth()->user();
    $amount = $request->amount;
    $transactionId = 'TXN_' . time();
    
    // X·ª≠ l√Ω n·∫°p ti·ªÅn v√†o v√≠
    // ...
    
    // K√≠ch ho·∫°t event
    event(new WalletDeposited($user, $amount, $transactionId));
    
    return response()->json(['success' => true]);
}
```

### 4. K√≠ch Ho·∫°t Th√¥ng B√°o R√∫t Ti·ªÅn V√≠

```php
// Trong Controller khi r√∫t ti·ªÅn t·ª´ v√≠
use App\Events\WalletWithdrawn;

public function withdraw(Request $request)
{
    $user = auth()->user();
    $amount = $request->amount;
    $transactionId = 'TXN_' . time();
    
    // X·ª≠ l√Ω r√∫t ti·ªÅn t·ª´ v√≠
    // ...
    
    // K√≠ch ho·∫°t event
    event(new WalletWithdrawn($user, $amount, $transactionId));
    
    return response()->json(['success' => true]);
}
```

### 5. L·∫Øng Nghe Th√¥ng B√°o Trong JavaScript

```javascript
// Cho Admin - ƒê∆°n h√†ng
window.Echo.channel('admin-orders')
    .listen('order.created', (data) => {
        console.log('ƒê∆°n h√†ng m·ªõi:', data);
        // Hi·ªÉn th·ªã th√¥ng b√°o
        showNotification('success', 'ƒê∆°n h√†ng m·ªõi', data.message);
        // C·∫≠p nh·∫≠t badge
        updateNotificationBadge();
        // Th√™m v√†o dropdown
        addNotificationToDropdown(data);
    });

// Cho Admin - Th√¥ng b√°o v√≠
window.Echo.channel('admin-wallets')
    .listen('wallet.deposited', (data) => {
        console.log('N·∫°p ti·ªÅn v√≠:', data);
        showNotification(
            'success',
            'üí∞ N·∫°p ti·ªÅn v√≠!',
            `${data.customer_name} ƒë√£ n·∫°p ${data.amount}ƒë v√†o v√≠`
        );
        updateNotificationBadge();
        addNotificationToDropdown({
            title: 'N·∫°p ti·ªÅn v√≠!',
            message: `${data.customer_name} - ${data.amount}ƒë`,
            time: 'V·ª´a xong',
            icon: 'bx-wallet',
            type: 'success'
        });
    })
    .listen('wallet.withdrawn', (data) => {
        console.log('R√∫t ti·ªÅn v√≠:', data);
        showNotification(
            'warning',
            'üí∏ R√∫t ti·ªÅn v√≠!',
            `${data.customer_name} ƒë√£ r√∫t ${data.amount}ƒë t·ª´ v√≠`
        );
        updateNotificationBadge();
        addNotificationToDropdown({
            title: 'R√∫t ti·ªÅn v√≠!',
            message: `${data.customer_name} - ${data.amount}ƒë`,
            time: 'V·ª´a xong',
            icon: 'bx-money-withdraw',
            type: 'warning'
        });
    });

// Cho Kh√°ch h√†ng - ƒê∆°n h√†ng
window.Echo.channel(`customer-${userId}`)
    .listen('order.status.updated', (data) => {
        console.log('Tr·∫°ng th√°i ƒë∆°n h√†ng c·∫≠p nh·∫≠t:', data);
        showNotification('info', 'C·∫≠p nh·∫≠t ƒë∆°n h√†ng', data.message);
    })
    // L·∫Øng nghe th√¥ng b√°o n·∫°p ti·ªÅn v√≠
    .listen('wallet.deposited', (data) => {
        console.log('N·∫°p ti·ªÅn v√†o v√≠:', data);
        showNotification(
            'success', 
            'üí∞ N·∫°p ti·ªÅn th√†nh c√¥ng',
            `B·∫°n ƒë√£ n·∫°p th√†nh c√¥ng ${new Intl.NumberFormat('vi-VN').format(data.amount)}ƒë v√†o v√≠ l√∫c ${data.deposited_at}`
        );
    })
    // L·∫Øng nghe th√¥ng b√°o r√∫t ti·ªÅn v√≠
    .listen('wallet.withdrawn', (data) => {
        console.log('R√∫t ti·ªÅn t·ª´ v√≠:', data);
        showNotification(
            'info',
            'üí∏ R√∫t ti·ªÅn th√†nh c√¥ng', 
            `B·∫°n ƒë√£ r√∫t th√†nh c√¥ng ${new Intl.NumberFormat('vi-VN').format(data.amount)}ƒë t·ª´ v√≠ l√∫c ${data.withdrawn_at}`
        );
    });
```

## üß™ Testing

### 1. Test Routes
```php
// routes/web.php
Route::get('/test-notification', function () {
    $order = Order::first();
    if ($order) {
        event(new OrderCreated($order));
        return response()->json([
            'message' => 'Test notification sent',
            'order' => [
                'id' => $order->id,
                'order_code' => $order->order_code,
                'customer_name' => $order->customer_name,
                'total_amount' => $order->total_amount
            ],
            'timestamp' => now()
        ]);
    }
    return response()->json(['error' => 'No orders found'], 404);
});

Route::get('/test-notification-page', function () {
    return view('test-notification');
});
```

### 2. Test Commands
```bash
# Build assets
npm run build

# Test notification ƒë∆°n h√†ng
curl http://localhost:8000/test-notification

# Test th√¥ng b√°o n·∫°p ti·ªÅn v√≠ (kh√°ch h√†ng)
curl http://localhost:8000/test-wallet-deposit

# Test th√¥ng b√°o r√∫t ti·ªÅn v√≠ (kh√°ch h√†ng)
curl http://localhost:8000/test-wallet-withdraw

# Test th√¥ng b√°o n·∫°p ti·ªÅn v√≠ cho admin
curl http://localhost:8000/test-admin-wallet-deposit

# Test th√¥ng b√°o r√∫t ti·ªÅn v√≠ cho admin
curl http://localhost:8000/test-admin-wallet-withdraw

# M·ªü trang test
http://localhost:8000/test-notification-page
```

### 3. Trang Test Interactive
Truy c·∫≠p: `http://localhost:8000/test-notification-page`

Trang n√†y cung c·∫•p:
- Ki·ªÉm tra k·∫øt n·ªëi Echo
- Test th√¥ng b√°o local
- G·ª≠i test order
- Console log realtime
- Dropdown th√¥ng b√°o m√¥ ph·ªèng

## üîß Troubleshooting

### 1. Echo kh√¥ng kh·ªüi t·∫°o
**Tri·ªáu ch·ª©ng**: `Echo is undefined`

**Gi·∫£i ph√°p**:
```bash
# Ki·ªÉm tra build
npm run build

# Ki·ªÉm tra .env
echo $VITE_PUSHER_APP_KEY
echo $VITE_PUSHER_APP_CLUSTER
```

### 2. Kh√¥ng nh·∫≠n ƒë∆∞·ª£c th√¥ng b√°o
**Tri·ªáu ch·ª©ng**: Event ƒë∆∞·ª£c fire nh∆∞ng frontend kh√¥ng nh·∫≠n

**Ki·ªÉm tra**:
1. Pusher credentials ƒë√∫ng
2. User ƒë√£ ƒëƒÉng nh·∫≠p
3. Meta tags user-id v√† user-role c√≥ gi√° tr·ªã
4. Channel name ƒë√∫ng
5. Event name ƒë√∫ng

### 3. L·ªói CORS
**Tri·ªáu ch·ª©ng**: `Access-Control-Allow-Origin` error

**Gi·∫£i ph√°p**:
```php
// config/cors.php
'paths' => ['api/*', 'sanctum/csrf-cookie', 'broadcasting/auth'],
```

### 4. Authentication Error
**Tri·ªáu ch·ª©ng**: `403 Forbidden` khi connect private channel

**Ki·ªÉm tra**:
1. CSRF token trong meta tag
2. Auth headers trong echo.js
3. Broadcasting auth route

## üìä Monitoring

### 1. Debug Logs
```javascript
// Trong notifications.js
console.log('üöÄ Kh·ªüi t·∫°o th√¥ng b√°o cho', userRole, 'ID:', userId);
console.log('‚úÖ Echo s·∫µn s√†ng');
console.log('üéâ Nh·∫≠n ƒë∆∞·ª£c th√¥ng b√°o:', data);
```

### 2. Laravel Logs
```php
// Trong Event
Log::info('OrderCreated event fired', ['order_id' => $this->order->id]);
```

### 3. Pusher Dashboard
Truy c·∫≠p Pusher dashboard ƒë·ªÉ xem:
- Connection count
- Message count
- Error logs

## üîí Security

### 1. Private Channels
```php
// routes/channels.php
Broadcast::channel('user.{id}', function ($user, $id) {
    return (int) $user->id === (int) $id;
});
```

### 2. CSRF Protection
```javascript
// echo.js
auth: {
    headers: {
        'X-CSRF-TOKEN': csrfToken,
        'X-Requested-With': 'XMLHttpRequest',
        'Accept': 'application/json'
    }
}
```

## üìà Performance

### 1. Gi·ªõi H·∫°n Th√¥ng B√°o
```javascript
// Gi·ªõi h·∫°n 5 th√¥ng b√°o trong dropdown
if (list.children.length > 5) {
    list.removeChild(list.lastChild);
}
```

### 2. Debounce Updates
```javascript
// Debounce badge updates
let badgeUpdateTimeout;
function updateBadge(count) {
    clearTimeout(badgeUpdateTimeout);
    badgeUpdateTimeout = setTimeout(() => {
        // Update badge
    }, 100);
}
```

## üéØ Best Practices

1. **Lu√¥n validate d·ªØ li·ªáu** tr∆∞·ªõc khi broadcast
2. **S·ª≠ d·ª•ng queue** cho events n·∫∑ng
3. **Gi·ªõi h·∫°n s·ªë l∆∞·ª£ng** th√¥ng b√°o hi·ªÉn th·ªã
4. **Implement retry logic** cho failed connections
5. **Log t·∫•t c·∫£ events** ƒë·ªÉ debug
6. **Test tr√™n nhi·ªÅu browser** v√† device
7. **Monitor Pusher usage** ƒë·ªÉ tr√°nh v∆∞·ª£t quota

## üìù Changelog

### v1.0.0 (2025-08-17)
- ‚úÖ T·∫°o Model Notification v√† migration
- ‚úÖ T·∫°o Event OrderCreated v√† OrderStatusUpdated
- ‚úÖ C·∫•u h√¨nh Laravel Echo v√† Pusher
- ‚úÖ T·∫°o JavaScript notifications.js
- ‚úÖ T·∫°o trang test interactive
- ‚úÖ Debug v√† fix c√°c v·∫•n ƒë·ªÅ k·∫øt n·ªëi
- ‚úÖ Ho√†n thi·ªán t√†i li·ªáu h∆∞·ªõng d·∫´n

---

**T√°c gi·∫£**: AI Assistant  
**Ng√†y t·∫°o**: 17/08/2025  
**Phi√™n b·∫£n**: 1.0.0